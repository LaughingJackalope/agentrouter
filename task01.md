

````markdown
# Jules Task 01: Define & Finalize Core Pub/Sub Message Schema

## âœ… Task Completion Status: Completed

## ðŸ“‹ Summary
The Pub/Sub message schema has been successfully defined and implemented. The schema includes:
- **Data Payload**: Structured format for message content
- **Attributes**: Standard metadata including message type, timestamp, and source
- **Idempotency**: Support for idempotent message processing
- **Mapping Logic**: Clear transformation rules from API requests to Pub/Sub messages

## ðŸ“‚ Output Files
- `schemas/pubsub/pubsub_message_schema.json`
- `schemas/pubsub/README.md`

---

# Original Task Details
# Jules Task 01: Define & Finalize Core Pub/Sub Message Schema

## 1. Task Objective

This task is to formally define and document the exact JSON structure for the `data` payload and the required `attributes` of messages that will be published to Google Pub/Sub for the AI Agent Message Routing Component. This finalized schema will serve as the core contract for the **Message Router** (publisher) and the **AI Agent Consumer Components** (subscribers).

This task is a foundational step in **Phase 1: Core Routing MVP** of the development roadmap.

## 2. Context & Rationale

The Pub/Sub message schema is fundamental to the entire message routing pipeline. It ensures:

* **Interoperability:** A clear and consistent contract between the Message Router and AI Agent Consumer Components.
* **Idempotency:** By explicitly including a `messageId` in attributes, enabling agents to process messages exactly once even with Pub/Sub's "at-least-once" delivery guarantee.
* **Auditability & Tracing:** Through the inclusion of metadata like `senderId`, `correlationId`, and `timestampPublished`.

The **Message Router** will receive messages via an external RESTful API (`POST /v1/messages`) and transform them into this Pub/Sub message format before publishing.

## 3. Detailed Requirements

A Google Cloud Pub/Sub message consists of two main parts: `data` and `attributes`.

### 3.1. Pub/Sub Message `data` Field Structure

* **Purpose:** This field will carry the actual message content intended for the AI Agent. The Message Router should treat this as an opaque payload, essentially passing it through from the incoming API request.
* **Format:** The `data` field **must be a Base64 encoded JSON string**. This means the original `payload` (which is a JSON object) from the incoming API request will first be stringified into JSON, then that string will be Base64 encoded.
* **Flexibility:** The underlying JSON structure within the Base64 encoded string is defined by the sender and intended for the AI Agent. The Message Router does not parse or validate its internal structure.

### 3.2. Pub/Sub Message `attributes` Field Structure

The `attributes` field is a map of string keys to string values. All attributes listed below are **REQUIRED** unless explicitly marked as **OPTIONAL**.

* **`messageId` (string, REQUIRED):**
    * **Purpose:** This serves as a unique identifier for the message, generated by the Message Routing Component. It is critical for the AI Agent Consumer Component to implement idempotency checks.
    * **Source:** This UUID will be generated by the Message Routing Component upon successful ingestion of the message via the `POST /v1/messages` API. It is also returned to the sender in the `202 Accepted` API response.
    * **Format:** A universally unique identifier (UUID), for example: `"mrc-generated-uuid-12345"`.

* **`aiAgentAddress` (string, REQUIRED):**
    * **Purpose:** Identifies the target AI Agent for whom the message is intended. This is the primary routing key.
    * **Source:** Derived directly from the `aiAgentAddress` field in the incoming `POST /v1/messages` API request payload.
    * **Format:** A string, for example: `"agent-sales@yourorg.com"`.

* **`senderId` (string, OPTIONAL):**
    * **Purpose:** Provides an identifier for the system or service that originated the message, valuable for auditing and troubleshooting.
    * **Source:** Corresponds to the `senderMetadata.serviceName` field from the incoming `POST /v1/messages` API request payload, if present.
    * **Format:** A string, for example: `"CRM_System"`.

* **`correlationId` (string, OPTIONAL):**
    * **Purpose:** An identifier provided by the sender for their own tracking of complex workflows.
    * **Source:** Corresponds to the `senderMetadata.correlationId` field from the incoming `POST /v1/messages` API request payload, if present.
    * **Format:** A string, for example: `"crm-request-abc-789"`.

* **`timestampPublished` (string, REQUIRED):**
    * **Purpose:** Records the exact time the message was successfully published to Pub/Sub by the Message Router. Crucial for auditing, message age policies, and latency monitoring.
    * **Source:** The UTC timestamp generated by the Message Routing Component at the point of successful Pub/Sub publication.
    * **Format:** ISO 8601 format, representing UTC time, for example: `"2025-06-23T17:16:10.000Z"`.

* **`contentType` (string, OPTIONAL):**
    * **Purpose:** Indicates the content type of the `data` payload, helping AI Agents correctly parse and interpret the message.
    * **Source:** Can be inferred by the Message Router (e.g., if the original API `payload` was a JSON object, then `application/json`).
    * **Format:** A standard MIME type string, for example: `"application/json"`, `"text/plain"`.

### 3.3. Example Pub/Sub Message Structure (JSON Representation)

Below is an example of what a complete Pub/Sub message would look like in JSON. Note that `data` is Base64 encoded.

```json
{
  "data": "eyJhZ2VudENvbW1hbmQiOiAicHJvY2VzcyBPcmRlciAxMjMiLCAicHJvZHVjdHMiOiBbIml0ZW0xIiwgIml0ZW0yIl19",
  "attributes": {
    "messageId": "mrc-generated-uuid-12345",
    "aiAgentAddress": "agent-sales@yourorg.com",
    "senderId": "CRM_System",
    "correlationId": "crm-request-abc-789",
    "timestampPublished": "2025-06-23T17:16:10.000Z",
    "contentType": "application/json"
  }
}
````

*Decoded `data` field content (for illustration only, Jules should not decode):*

```json
{
  "agentCommand": "process Order 123",
  "products": ["item1", "item2"]
}
```

### 3.4. Mapping from Incoming API Request to Pub/Sub Schema

The `POST /v1/messages` API request payload looks like this:

```json
{
  "aiAgentAddress": "string",             // REQUIRED. The unique address of the target AI Agent. e.g., "agent-sales@yourorg.com"
  "payload": {},                        // REQUIRED. The actual message content for the AI Agent (can be any valid JSON object).
  "senderMetadata": {                   // OPTIONAL. Metadata about the sender.
    "serviceName": "string",            // e.g., "CRM_System"
    "correlationId": "string",          // A sender-specific ID for request correlation.
    "senderProvidedMessageId": "string" // OPTIONAL. An ID provided by the sender for their own tracking.
  }
}
```

Jules should implement the mapping logic as follows:

  * The JSON object from `request.payload` will be stringified and then Base64 encoded to become `pubsub.data`.
  * `request.aiAgentAddress` maps directly to `pubsub.attributes.aiAgentAddress`.
  * `request.senderMetadata.serviceName` maps to `pubsub.attributes.senderId` (if present).
  * `request.senderMetadata.correlationId` maps to `pubsub.attributes.correlationId` (if present).
  * `pubsub.attributes.messageId` will be a newly generated UUID by the Message Router Component. This `messageId` is also returned in the `202 Accepted` HTTP response to the sender.
  * `pubsub.attributes.timestampPublished` will be the current UTC timestamp generated by the Message Router when it publishes the message.
  * `pubsub.attributes.contentType` should be set to `"application/json"` if the `request.payload` was a JSON object.

## 4\. Expected Output from Jules

Upon completion, Jules should provide:

  * A definitive, formally documented JSON Schema Definition (e.g., `pubsub_message_schema.json`) for the Pub/Sub message structure (including both the `data` and `attributes` fields, with their types and requirements).
  * Any necessary code snippets or pseudo-code demonstrating the exact mapping logic from the incoming API request to this Pub/Sub message format, including the Base64 encoding step for the `data` field.
  * Confirmation that the generated schema definition and mapping logic align with idempotency requirements and the stated needs of AI Agent consumers.

